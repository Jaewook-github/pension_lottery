{% extends "base.html" %}

{% block title %}ì—°ê¸ˆë³µê¶Œ íŒ¨í„´ ë¶„ì„ - ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block header_title %}ğŸ“Š ë¶„ì„ ëŒ€ì‹œë³´ë“œ{% endblock %}
{% block header_subtitle %}ìƒì„¸í•œ íŒ¨í„´ ë¶„ì„ ê²°ê³¼ì™€ í†µê³„{% endblock %}

{% block head %}
<style>
    .tabs {
        display: flex;
        background: white;
        border-radius: 10px 10px 0 0;
        overflow: hidden;
        margin-bottom: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tab {
        flex: 1;
        padding: 15px 20px;
        background: #f8f9fa;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        color: #495057;
    }
    
    .tab.active {
        background: white;
        color: #007bff;
    }
    
    .tab:hover {
        background: #e9ecef;
    }
    
    .tab.active:hover {
        background: white;
    }
    
    .tab-content {
        background: white;
        padding: 25px;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    .frequency-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .frequency-table th,
    .frequency-table td {
        padding: 8px 12px;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    .frequency-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .frequency-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .frequency-table tr:hover {
        background-color: #e3f2fd;
    }
    
    .companion-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px;
        background: #f8f9fa;
    }
    
    .companion-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 5px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .companion-item:last-child {
        margin-bottom: 0;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .chart-container {
        text-align: center;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-container img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-container h4 {
        margin-bottom: 15px;
        color: #495057;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .trend-score {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
    }
    
    .trend-hot {
        background: #dc3545;
    }
    
    .trend-warm {
        background: #fd7e14;
    }
    
    .trend-cool {
        background: #20c997;
    }
    
    .trend-cold {
        background: #0dcaf0;
    }
</style>
{% endblock %}

{% block content %}
<!-- íƒ­ ë©”ë‰´ -->
<div class="tabs">
    <button class="tab active" onclick="showTab('overview')">ğŸ“Š ê°œìš”</button>
    <button class="tab" onclick="showTab('frequency')">ğŸ”¢ ì¶œí˜„ ë¹ˆë„</button>
    <button class="tab" onclick="showTab('companion')">ğŸ¤ ë™ë°˜ ì¶œí˜„</button>
    <button class="tab" onclick="showTab('trends')">ğŸ“ˆ íŠ¸ë Œë“œ</button>
    <button class="tab" onclick="showTab('charts')">ğŸ“ˆ ì°¨íŠ¸</button>
</div>

<div class="tab-content">
    <!-- ê°œìš” íƒ­ -->
    <div id="overview" class="tab-pane active">
        <h3>ğŸ“Š ë¶„ì„ ê°œìš”</h3>
        
        {% if basic_stats and number_summary %}
            <div class="grid">
                <div class="card">
                    <h3>ê¸°ë³¸ í†µê³„</h3>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-value">{{ "{:,}".format(basic_stats.total_rounds) if basic_stats.total_rounds else 'N/A' }}</div>
                            <div class="stat-label">ì´ íšŒì°¨</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ basic_stats.most_frequent_jo.jo if basic_stats.most_frequent_jo else 'N/A' }}</div>
                            <div class="stat-label">ìµœë‹¤ ì¶œí˜„ ì¡°</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ basic_stats.most_frequent_jo.count if basic_stats.most_frequent_jo else 'N/A' }}</div>
                            <div class="stat-label">ì¶œí˜„ íšŸìˆ˜</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ number_summary.frequency_analysis.most_frequent_second[0] if number_summary.frequency_analysis.most_frequent_second else 'N/A' }}</div>
                            <div class="stat-label">2ë“± ìµœë‹¤ë²ˆí˜¸</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>ë¶„ì„ ì •ë³´</h3>
                    <p><strong>ë°ì´í„° ë²”ìœ„:</strong> {{ number_summary.analysis_summary.data_range if number_summary.analysis_summary else 'N/A' }}</p>
                    <p><strong>ë¶„ì„ ì¼ì‹œ:</strong> 
                        {% if number_summary.analysis_summary.analysis_date %}
                            {{ number_summary.analysis_summary.analysis_date[:19].replace('T', ' ') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                    <p><strong>ì´ ë¶„ì„ íšŒì°¨:</strong> {{ "{:,}".format(number_summary.analysis_summary.total_rounds) if number_summary.analysis_summary else 'N/A' }}íšŒ</p>
                </div>
            </div>
            
            <div class="card">
                <h3>ì£¼ìš” ì¸ì‚¬ì´íŠ¸</h3>
                {% if number_summary.companion_analysis.insights %}
                    <ul style="padding-left: 20px;">
                        {% for insight in number_summary.companion_analysis.insights %}
                            <li style="margin-bottom: 8px;">{{ insight }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>ì¸ì‚¬ì´íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                {% endif %}
            </div>
        {% else %}
            <div class="no-data">
                <h4>ğŸ“‹ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                <p>ë¨¼ì € í¬ë¡¤ë§ê³¼ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="executeAction('crawl')">ğŸ•·ï¸ ë°ì´í„° í¬ë¡¤ë§</button>
                    <button class="btn btn-success" onclick="executeAction('analyze')">ğŸ“ˆ ê¸°ë³¸ ë¶„ì„</button>
                    <button class="btn btn-info" onclick="executeAction('number_analyze')">ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„</button>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- ì¶œí˜„ ë¹ˆë„ íƒ­ -->
    <div id="frequency" class="tab-pane">
        <h3>ğŸ”¢ ë²ˆí˜¸ë³„ ì¶œí˜„ ë¹ˆë„</h3>
        
        {% if number_frequency %}
            <div class="grid">
                {% for pos in range(1, 7) %}
                    <div class="card">
                        <h3>{{ pos }}ìë¦¬ ì¶œí˜„ ë¹ˆë„</h3>
                        {% set pos_key = "1ë“±_" + pos|string + "ìë¦¬" %}
                        {% if number_frequency.first_numbers[pos_key] %}
                            <table class="frequency-table">
                                <thead>
                                    <tr>
                                        <th>ìˆ«ì</th>
                                        <th>ì¶œí˜„ íšŸìˆ˜</th>
                                        <th>ë¹„ìœ¨(%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set total = number_frequency.first_numbers[pos_key].values() | sum %}
                                    {% for digit, count in number_frequency.first_numbers[pos_key].items() | sort(attribute='1', reverse=true) %}
                                        {% set percentage = ((count / total) * 100) | round(1) if total > 0 else 0 %}
                                        <tr>
                                            <td><strong>{{ digit }}</strong></td>
                                            <td>{{ count }}</td>
                                            <td>{{ percentage }}%</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>
                {% endfor %}
                
                <div class="card">
                    <h3>2ë“± ëìë¦¬ ì¶œí˜„ ë¹ˆë„</h3>
                    <table class="frequency-table">
                        <thead>
                            <tr>
                                <th>ëìë¦¬</th>
                                <th>ì¶œí˜„ íšŸìˆ˜</th>
                                <th>ë¹„ìœ¨(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set total_second = number_frequency.second_numbers.values() | sum %}
                            {% for digit, count in number_frequency.second_numbers.items() | sort(attribute='1', reverse=true) %}
                                {% set percentage = ((count / total_second) * 100) | round(1) if total_second > 0 else 0 %}
                                <tr>
                                    <td><strong>{{ digit }}</strong></td>
                                    <td>{{ count }}</td>
                                    <td>{{ percentage }}%</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="no-data">
                <h4>ğŸ”¢ ë²ˆí˜¸ë³„ ë¹ˆë„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                <p>ë²ˆí˜¸ë³„ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
                <button class="btn btn-info" onclick="executeAction('number_analyze')">ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„ ì‹¤í–‰</button>
            </div>
        {% endif %}
    </div>
    
    <!-- ë™ë°˜ ì¶œí˜„ íƒ­ -->
    <div id="companion" class="tab-pane">
        <h3>ğŸ¤ ë²ˆí˜¸ë³„ ë™ë°˜ ì¶œí˜„ ë¶„ì„</h3>
        
        {% if companion_numbers and companion_numbers.top_companions %}
            <div class="grid">
                {% for pos in range(1, 7) %}
                    <div class="card">
                        <h3>{{ pos }}ìë¦¬ ì£¼ìš” ë™ë°˜ ì¶œí˜„</h3>
                        <div class="companion-list">
                            {% set found_data = false %}
                            {% for pos_digit, companions in companion_numbers.top_companions.items() %}
                                {% if pos_digit.startswith("ìë¦¬" + pos|string + "_") %}
                                    {% set found_data = true %}
                                    {% set digit = pos_digit.split("_")[1] %}
                                    <div style="margin-bottom: 15px;">
                                        <strong style="color: #007bff;">{{ digit }}ë²ˆê³¼ í•¨ê»˜ ë‚˜ì˜¨ ìˆ«ìë“¤:</strong>
                                        {% for comp_data in companions[:5] %}
                                            <div class="companion-item">
                                                <span>{{ comp_data[0] }}</span>
                                                <span><strong>{{ comp_data[1] }}íšŒ</strong></span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                            {% if not found_data %}
                                <p>í•´ë‹¹ ìë¦¬ì˜ ë™ë°˜ ì¶œí˜„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-data">
                <h4>ğŸ¤ ë™ë°˜ ì¶œí˜„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                <p>ë²ˆí˜¸ë³„ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
                <button class="btn btn-info" onclick="executeAction('number_analyze')">ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„ ì‹¤í–‰</button>
            </div>
        {% endif %}
    </div>
    
    <!-- íŠ¸ë Œë“œ íƒ­ -->
    <div id="trends" class="tab-pane">
        <h3>ğŸ“ˆ ìµœê·¼ íŠ¸ë Œë“œ ë¶„ì„</h3>
        
        {% if number_trends and number_trends.trend_scores %}
            <p><strong>ë¶„ì„ ê¸°ê°„:</strong> {{ number_trends.analysis_period if number_trends.analysis_period else 'N/A' }}</p>
            
            <div class="grid">
                {% for pos in range(1, 7) %}
                    <div class="card">
                        <h3>{{ pos }}ìë¦¬ íŠ¸ë Œë“œ ì ìˆ˜</h3>
                        {% set pos_key = "ìë¦¬" + pos|string %}
                        {% if number_trends.trend_scores[pos_key] %}
                            <table class="frequency-table">
                                <thead>
                                    <tr>
                                        <th>ìˆ«ì</th>
                                        <th>íŠ¸ë Œë“œ ì ìˆ˜</th>
                                        <th>ìµœê·¼ ì¶œí˜„</th>
                                        <th>ì¶œí˜„ íšŸìˆ˜</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for digit, data in number_trends.trend_scores[pos_key].items() | sort(attribute='1.recent_score', reverse=true) %}
                                        {% set score = data.recent_score %}
                                        {% set score_class = "trend-hot" if score > 0.5 else ("trend-warm" if score > 0.3 else ("trend-cool" if score > 0.1 else "trend-cold")) %}
                                        <tr>
                                            <td><strong>{{ digit }}</strong></td>
                                            <td><span class="trend-score {{ score_class }}">{{ "%.2f"|format(score) }}</span></td>
                                            <td>{{ data.last_appearance }}íšŒ</td>
                                            <td>{{ data.frequency }}íšŒ</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>í•´ë‹¹ ìë¦¬ì˜ íŠ¸ë Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-data">
                <h4>ğŸ“ˆ íŠ¸ë Œë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                <p>ë²ˆí˜¸ë³„ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
                <button class="btn btn-info" onclick="executeAction('number_analyze')">ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„ ì‹¤í–‰</button>
            </div>
        {% endif %}
    </div>
    
    <!-- ì°¨íŠ¸ íƒ­ -->
    <div id="charts" class="tab-pane">
        <h3>ğŸ“ˆ ë¶„ì„ ì°¨íŠ¸</h3>
        
        <div class="chart-grid" id="charts-container">
            <!-- ì°¨íŠ¸ë“¤ì€ JavaScriptë¡œ ë™ì  ë¡œë“œ -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// íƒ­ ê¸°ëŠ¥
function showTab(tabName) {
    // ëª¨ë“  íƒ­ê³¼ íƒ­ ë‚´ìš© ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
    
    // ì„ íƒëœ íƒ­ê³¼ ë‚´ìš© ë³´ì´ê¸°
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    
    // ì°¨íŠ¸ íƒ­ì´ ì„ íƒë˜ë©´ ì°¨íŠ¸ ë¡œë“œ
    if (tabName === 'charts') {
        loadCharts();
    }
}

// ì°¨íŠ¸ ë¡œë“œ í•¨ìˆ˜
function loadCharts() {
    const container = document.getElementById('charts-container');
    if (!container) return;
    
    // ì´ë¯¸ ë¡œë“œë˜ì—ˆìœ¼ë©´ ë¦¬í„´
    if (container.children.length > 0) return;
    
    fetch('/api/charts')
    .then(response => response.json())
    .then(charts => {
        if (charts.length === 0) {
            container.innerHTML = `
                <div class="no-data">
                    <h4>ğŸ“ˆ ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                    <p>ë¶„ì„ì„ ì‹¤í–‰í•˜ì—¬ ì°¨íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</p>
                    <button class="btn btn-success" onclick="executeAction('analyze')">ğŸ“ˆ ê¸°ë³¸ ë¶„ì„</button>
                    <button class="btn btn-info" onclick="executeAction('number_analyze')">ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„</button>
                </div>
            `;
            return;
        }
        
        let chartsHtml = '';
        charts.forEach(chart => {
            chartsHtml += `
                <div class="chart-container">
                    <h4>${chart.title}</h4>
                    <img src="/charts/${chart.filename}?v=${Date.now()}" 
                         alt="${chart.title}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; padding: 20px; background: #f8f9fa; border-radius: 6px; color: #6c757d;">
                        ì°¨íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                    ${chart.modified ? `<small style="color: #6c757d;">ìƒì„±: ${chart.modified}</small>` : ''}
                </div>
            `;
        });
        
        container.innerHTML = chartsHtml;
    })
    .catch(error => {
        container.innerHTML = `
            <div class="no-data">
                <h4>âŒ ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨</h4>
                <p>ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}</p>
            </div>
        `;
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    // í˜„ì¬ í™œì„± íƒ­ì´ ì°¨íŠ¸ë©´ ì°¨íŠ¸ ë¡œë“œ
    if (document.getElementById('charts').classList.contains('active')) {
        loadCharts();
    }
});
</script>
{% endblock %}