{% extends "base.html" %}

{% block title %}ì—°ê¸ˆë³µê¶Œ íŒ¨í„´ ë¶„ì„ - ëŒ€ì‹œë³´ë“œ{% endblock %}

{% block header_title %}ğŸ“Š ë¶„ì„ ëŒ€ì‹œë³´ë“œ{% endblock %}
{% block header_subtitle %}ì—°ê¸ˆë³µê¶Œ ë‹¹ì²¨ë²ˆí˜¸ íŒ¨í„´ ë¶„ì„ ì¢…í•© ê²°ê³¼{% endblock %}

{% block head %}
<style>
    .dashboard-tabs {
        display: flex;
        background: white;
        border-radius: 10px;
        padding: 5px;
        margin-bottom: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow-x: auto;
    }

    .tab {
        flex: 1;
        padding: 15px 20px;
        border-radius: 8px;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        white-space: nowrap;
        min-width: 140px;
    }

    .tab:hover {
        background: #e3f2fd;
        color: #1976d2;
    }

    .tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 8px;
        line-height: 1;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .stat-detail {
        color: #495057;
        font-size: 0.8em;
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
    }

    .chart-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #495057;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }

    .chart-container img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .data-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }

    .data-table table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .data-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 10px;
        text-align: center;
        font-weight: 600;
    }

    .data-table td {
        padding: 12px 10px;
        text-align: center;
        border-bottom: 1px solid #e9ecef;
    }

    .data-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .data-table tr:hover {
        background-color: #e3f2fd;
        transform: scale(1.01);
        transition: all 0.2s ease;
    }

    .no-data {
        text-align: center;
        padding: 60px 40px;
        color: #6c757d;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .no-data h4 {
        margin-bottom: 15px;
        color: #495057;
    }

    .insights-box {
        background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
        border: 1px solid #c3e6c3;
        border-radius: 12px;
        padding: 25px;
        margin: 25px 0;
        border-left: 4px solid #28a745;
    }

    .insights-box h5 {
        color: #155724;
        margin-bottom: 15px;
        font-weight: 600;
    }

    .insights-box ul {
        margin: 10px 0;
        padding-left: 25px;
    }

    .insights-box li {
        color: #155724;
        margin: 8px 0;
        line-height: 1.5;
    }

    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 25px;
        margin: 25px 0;
    }

    .loading-chart {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px;
        color: #6c757d;
    }

    .loading-chart .spinner {
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<!-- ëŒ€ì‹œë³´ë“œ íƒ­ ë©”ë‰´ -->
<div class="dashboard-tabs">
    <button class="tab active" onclick="showTab('overview')">ğŸ“‹ ì¢…í•©</button>
    <button class="tab" onclick="showTab('basic')">ğŸ“ˆ ê¸°ë³¸ë¶„ì„</button>
    <button class="tab" onclick="showTab('numbers')">ğŸ”¢ ë²ˆí˜¸ë¶„ì„</button>
    <button class="tab" onclick="showTab('trends')">ğŸ“Š íŠ¸ë Œë“œ</button>
    <button class="tab" onclick="showTab('charts')">ğŸ“ˆ ì°¨íŠ¸</button>
</div>

<!-- ì¢…í•© í˜„í™© íƒ­ -->
<div id="overview" class="tab-pane active">
    {% if basic_stats %}
        <!-- ì£¼ìš” í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ basic_stats.analysis_summary.total_rounds }}</div>
                <div class="stat-label">ë¶„ì„ íšŒì°¨</div>
                <div class="stat-detail">{{ basic_stats.analysis_summary.data_range }}</div>
            </div>

            {% if basic_stats.jo_analysis %}
            <div class="stat-card">
                <div class="stat-number">{{ basic_stats.jo_analysis.most_frequent_jo.jo }}ì¡°</div>
                <div class="stat-label">ìµœë‹¤ ì¶œí˜„ ì¡°</div>
                <div class="stat-detail">{{ basic_stats.jo_analysis.most_frequent_jo.count }}íšŒ ({{ basic_stats.jo_analysis.most_frequent_jo.percentage }}%)</div>
            </div>
            {% endif %}

            {% if basic_stats.second_number_analysis %}
            <div class="stat-card">
                <div class="stat-number">{{ basic_stats.second_number_analysis.most_frequent_digit.digit }}</div>
                <div class="stat-label">ìµœë‹¤ ëìë¦¬</div>
                <div class="stat-detail">{{ basic_stats.second_number_analysis.most_frequent_digit.count }}íšŒ ì¶œí˜„</div>
            </div>
            {% endif %}

            {% if number_summary %}
            <div class="stat-card">
                <div class="stat-number">{{ number_summary.total_companion_patterns }}</div>
                <div class="stat-label">ë™ë°˜ íŒ¨í„´</div>
                <div class="stat-detail">ë°œê²¬ëœ ì¡°í•© ìˆ˜</div>
            </div>
            {% endif %}
        </div>

        <!-- ì£¼ìš” ì¸ì‚¬ì´íŠ¸ -->
        {% if basic_stats.key_insights %}
        <div class="insights-box">
            <h5>ğŸ’¡ ì£¼ìš” ë¶„ì„ ì¸ì‚¬ì´íŠ¸</h5>
            <ul>
                {% for insight in basic_stats.key_insights %}
                    <li>{{ insight }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    {% else %}
        <div class="no-data">
            <h4>ğŸ“Š ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
            <p>ê¸°ë³¸ ë¶„ì„ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-primary" onclick="executeAction('analyze')">
                ğŸ“ˆ ê¸°ë³¸ ë¶„ì„ ì‹œì‘
            </button>
        </div>
    {% endif %}
</div>

<!-- ê¸°ë³¸ ë¶„ì„ íƒ­ -->
<div id="basic" class="tab-pane">
    {% if basic_stats %}
        <div class="row">
            <!-- ì¡°ë³„ ì¶œí˜„ ë¶„ì„ -->
            <div class="col-md-6">
                <div class="data-table">
                    <h4 style="padding: 15px; margin: 0; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">ì¡°ë³„ ì¶œí˜„ ë¶„ì„</h4>
                    {% if basic_stats.jo_analysis %}
                    <table>
                        <thead>
                            <tr>
                                <th>ì¡°</th>
                                <th>ì¶œí˜„ íšŸìˆ˜</th>
                                <th>ë¹„ìœ¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for jo, count in basic_stats.jo_analysis.jo_distribution.items() %}
                            <tr>
                                <td><strong>{{ jo }}ì¡°</strong></td>
                                <td>{{ count }}íšŒ</td>
                                <td>{{ basic_stats.jo_analysis.jo_percentages[jo] }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
            </div>

            <!-- ëìë¦¬ ë¶„ì„ -->
            <div class="col-md-6">
                <div class="data-table">
                    <h4 style="padding: 15px; margin: 0; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">ëìë¦¬ ì¶œí˜„ ë¶„ì„</h4>
                    {% if basic_stats.second_number_analysis %}
                    <table>
                        <thead>
                            <tr>
                                <th>ëìë¦¬</th>
                                <th>ì¶œí˜„ íšŸìˆ˜</th>
                                <th>ë¹„ìœ¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for digit, count in basic_stats.second_number_analysis.digit_distribution.items() %}
                            <tr>
                                <td><strong>{{ digit }}</strong></td>
                                <td>{{ count }}íšŒ</td>
                                <td>{{ basic_stats.second_number_analysis.digit_percentages[digit] }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- íŠ¸ë Œë“œ ë¶„ì„ -->
        {% if basic_stats.trend_analysis %}
        <div class="data-table">
            <h4 style="padding: 15px; margin: 0; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">ìµœê·¼ íŠ¸ë Œë“œ ë¶„ì„ ({{ basic_stats.trend_analysis.trend_period }})</h4>
            <table>
                <thead>
                    <tr>
                        <th>ì¡°</th>
                        <th>ì „ì²´ í‰ê· </th>
                        <th>ìµœê·¼ ë¹„ìœ¨</th>
                        <th>ë³€í™”ëŸ‰</th>
                        <th>íŠ¸ë Œë“œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for jo, trend in basic_stats.trend_analysis.jo_trends.items() %}
                    <tr>
                        <td><strong>{{ jo }}ì¡°</strong></td>
                        <td>{{ trend.overall_percentage }}%</td>
                        <td>{{ trend.recent_percentage }}%</td>
                        <td style="color: {% if trend.change > 0 %}#28a745{% elif trend.change < 0 %}#dc3545{% else %}#6c757d{% endif %};">
                            {% if trend.change > 0 %}+{% endif %}{{ trend.change }}%
                        </td>
                        <td>
                            {% if trend.trend == 'up' %}
                                <span style="color: #28a745;">ğŸ“ˆ ìƒìŠ¹</span>
                            {% elif trend.trend == 'down' %}
                                <span style="color: #dc3545;">ğŸ“‰ í•˜ë½</span>
                            {% else %}
                                <span style="color: #6c757d;">â¡ï¸ ì•ˆì •</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    {% else %}
        <div class="no-data">
            <h4>ğŸ“ˆ ê¸°ë³¸ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
            <p>ê¸°ë³¸ ë¶„ì„ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-success" onclick="executeAction('analyze')">
                ğŸ“ˆ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
            </button>
        </div>
    {% endif %}
</div>

<!-- ë²ˆí˜¸ ë¶„ì„ íƒ­ -->
<div id="numbers" class="tab-pane">
    {% if number_frequency %}
        <!-- ìë¦¬ë³„ ìµœë‹¤ ì¶œí˜„ ìˆ«ì -->
        <div class="stats-grid">
            {% for position, data in number_frequency.items() %}
                {% set most_frequent = data.items() | list | sort(attribute=1, reverse=true) | first %}
                <div class="stat-card">
                    <div class="stat-number">{{ most_frequent[0] }}</div>
                    <div class="stat-label">{{ position }} ìµœë‹¤</div>
                    <div class="stat-detail">{{ most_frequent[1] }}íšŒ ì¶œí˜„</div>
                </div>
            {% endfor %}
        </div>

        <!-- ìë¦¬ë³„ ìƒì„¸ ë¶„ì„ -->
        <div class="row">
            {% for position, data in number_frequency.items() %}
            <div class="col-md-6 col-lg-4">
                <div class="data-table">
                    <h5 style="padding: 12px; margin: 0; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">{{ position }} ë¶„ì„</h5>
                    <table style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>ìˆ«ì</th>
                                <th>íšŸìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for digit, count in data.items() | sort(attribute=1, reverse=true) %}
                            <tr>
                                <td><strong>{{ digit }}</strong></td>
                                <td>{{ count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>

        {% if number_summary and number_summary.key_insights %}
        <div class="insights-box">
            <h5>ğŸ”¢ ë²ˆí˜¸ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</h5>
            <ul>
                {% for insight in number_summary.key_insights %}
                    <li>{{ insight }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    {% else %}
        <div class="no-data">
            <h4>ğŸ”¢ ë²ˆí˜¸ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
            <p>ë²ˆí˜¸ë³„ ë¶„ì„ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-info" onclick="executeAction('number_analyze')">
                ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„ ì‹¤í–‰
            </button>
        </div>
    {% endif %}
</div>

<!-- íŠ¸ë Œë“œ ë¶„ì„ íƒ­ -->
<div id="trends" class="tab-pane">
    {% if number_trends %}
        <div class="row">
            {% for position, scores in number_trends.items() %}
            <div class="col-md-6 col-lg-4">
                <div class="data-table">
                    <h5 style="padding: 12px; margin: 0; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">{{ position }} íŠ¸ë Œë“œ</h5>
                    <table style="font-size: 0.9em;">
                        <thead>
                            <tr>
                                <th>ìˆ«ì</th>
                                <th>íŠ¸ë Œë“œ ì ìˆ˜</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for digit, score in scores.items() | sort(attribute=1, reverse=true) %}
                            <tr>
                                <td><strong>{{ digit }}</strong></td>
                                <td>{{ score }}</td>
                                <td>
                                    {% if score > 100 %}
                                        <span style="color: #dc3545;">ğŸ”¥ Hot</span>
                                    {% elif score < 100 %}
                                        <span style="color: #007bff;">â„ï¸ Cold</span>
                                    {% else %}
                                        <span style="color: #6c757d;">â¡ï¸ í‰ê· </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="insights-box">
            <h5>ğŸ“Š íŠ¸ë Œë“œ ì ìˆ˜ í•´ì„</h5>
            <ul>
                <li><strong>100 ì´ìƒ:</strong> ìµœê·¼ ìƒìŠ¹ ì¶”ì„¸ (Hot ë²ˆí˜¸)</li>
                <li><strong>100:</strong> í‰ê· ì  ì¶œí˜„ ë¹ˆë„</li>
                <li><strong>100 ë¯¸ë§Œ:</strong> ìµœê·¼ í•˜ë½ ì¶”ì„¸ (Cold ë²ˆí˜¸)</li>
            </ul>
        </div>
    {% else %}
        <div class="no-data">
            <h4>ğŸ“Š íŠ¸ë Œë“œ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
            <p>ë²ˆí˜¸ë³„ ë¶„ì„ì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
            <button class="btn btn-info" onclick="executeAction('number_analyze')">
                ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„ ì‹¤í–‰
            </button>
        </div>
    {% endif %}
</div>

<!-- ì°¨íŠ¸ ë³´ê¸° íƒ­ -->
<div id="charts" class="tab-pane">
    <div id="charts-container">
        <div class="loading-chart">
            <div class="spinner"></div>
            <p>ì°¨íŠ¸ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ëŒ€ì‹œë³´ë“œ íƒ­ ì „í™˜
function showTab(tabName) {
    // ëª¨ë“  íƒ­ê³¼ íŒ¨ë„ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });

    // í´ë¦­ëœ íƒ­ê³¼ í•´ë‹¹ íŒ¨ë„ì— active í´ë˜ìŠ¤ ì¶”ê°€
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');

    // ì°¨íŠ¸ íƒ­ì´ ì„ íƒë˜ë©´ ì°¨íŠ¸ ë¡œë“œ
    if (tabName === 'charts') {
        loadDashboardCharts();
    }
}

// ëŒ€ì‹œë³´ë“œìš© ì°¨íŠ¸ ë¡œë“œ
async function loadDashboardCharts() {
    const container = document.getElementById('charts-container');

    try {
        const response = await fetch('/api/charts');
        const charts = await response.json();

        if (charts.length === 0) {
            container.innerHTML = `
                <div class="no-data">
                    <h4>ğŸ“ˆ ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
                    <p>ë¶„ì„ì„ ì‹¤í–‰í•˜ì—¬ ì°¨íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</p>
                    <button class="btn btn-primary" onclick="executeAction('analyze')">
                        ğŸ“ˆ ë¶„ì„ ì‹œì‘
                    </button>
                </div>
            `;
            return;
        }

        let chartsHtml = '<div class="chart-grid">';
        charts.forEach(chart => {
            chartsHtml += `
                <div class="chart-container">
                    <div class="chart-title">${chart.title}</div>
                    <img src="/charts/${chart.filename}?v=${Date.now()}"
                         alt="${chart.title}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; padding: 20px; background: #f8f9fa; border-radius: 6px; color: #6c757d;">
                        ì°¨íŠ¸ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                    ${chart.modified ? `<small style="color: #6c757d; margin-top: 10px; display: block;">ìƒì„±: ${chart.modified}</small>` : ''}
                </div>
            `;
        });
        chartsHtml += '</div>';

        container.innerHTML = chartsHtml;

    } catch (error) {
        console.error('ì°¨íŠ¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        container.innerHTML = `
            <div class="no-data">
                <h4>âŒ ì°¨íŠ¸ ë¡œë“œ ì‹¤íŒ¨</h4>
                <p>ì°¨íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                <button class="btn btn-secondary" onclick="loadDashboardCharts()">
                    ğŸ”„ ë‹¤ì‹œ ì‹œë„
                </button>
            </div>
        `;
    }
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì°¨íŠ¸ ë¯¸ë¦¬ ë¡œë“œ
document.addEventListener('DOMContentLoaded', function() {
    // ì°¨íŠ¸ íƒ­ì´ ë‚˜ì¤‘ì— ì„ íƒë˜ì—ˆì„ ë•Œë¥¼ ìœ„í•´ ì¤€ë¹„
    console.log('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì™„ë£Œ');
});
</script>
{% endblock %}