{% extends "base.html" %}

{% block title %}연금복권 패턴 분석 - 대시보드{% endblock %}

{% block header_title %}📊 분석 대시보드{% endblock %}
{% block header_subtitle %}상세한 패턴 분석 결과와 통계{% endblock %}

{% block head %}
<style>
    .tabs {
        display: flex;
        background: white;
        border-radius: 10px 10px 0 0;
        overflow: hidden;
        margin-bottom: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tab {
        flex: 1;
        padding: 15px 20px;
        background: #f8f9fa;
        border: none;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        color: #495057;
    }
    
    .tab.active {
        background: white;
        color: #007bff;
    }
    
    .tab:hover {
        background: #e9ecef;
    }
    
    .tab.active:hover {
        background: white;
    }
    
    .tab-content {
        background: white;
        padding: 25px;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.active {
        display: block;
    }
    
    .frequency-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .frequency-table th,
    .frequency-table td {
        padding: 8px 12px;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    
    .frequency-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    
    .frequency-table tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    
    .frequency-table tr:hover {
        background-color: #e3f2fd;
    }
    
    .companion-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px;
        background: #f8f9fa;
    }
    
    .companion-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 5px;
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    .companion-item:last-child {
        margin-bottom: 0;
    }
    
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    
    .chart-container {
        text-align: center;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-container img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-container h4 {
        margin-bottom: 15px;
        color: #495057;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #6c757d;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 20px 0;
    }
    
    .trend-score {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
    }
    
    .trend-hot {
        background: #dc3545;
    }
    
    .trend-warm {
        background: #fd7e14;
    }
    
    .trend-cool {
        background: #20c997;
    }
    
    .trend-cold {
        background: #0dcaf0;
    }
</style>
{% endblock %}

{% block content %}
<!-- 탭 메뉴 -->
<div class="tabs">
    <button class="tab active" onclick="showTab('overview')">📊 개요</button>
    <button class="tab" onclick="showTab('frequency')">🔢 출현 빈도</button>
    <button class="tab" onclick="showTab('companion')">🤝 동반 출현</button>
    <button class="tab" onclick="showTab('trends')">📈 트렌드</button>
    <button class="tab" onclick="showTab('charts')">📈 차트</button>
</div>

<div class="tab-content">
    <!-- 개요 탭 -->
    <div id="overview" class="tab-pane active">
        <h3>📊 분석 개요</h3>
        
        {% if basic_stats and number_summary %}
            <div class="grid">
                <div class="card">
                    <h3>기본 통계</h3>
                    <div class="stat-grid">
                        <div class="stat-item">
                            <div class="stat-value">{{ "{:,}".format(basic_stats.total_rounds) if basic_stats.total_rounds else 'N/A' }}</div>
                            <div class="stat-label">총 회차</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ basic_stats.most_frequent_jo.jo if basic_stats.most_frequent_jo else 'N/A' }}</div>
                            <div class="stat-label">최다 출현 조</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ basic_stats.most_frequent_jo.count if basic_stats.most_frequent_jo else 'N/A' }}</div>
                            <div class="stat-label">출현 횟수</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ number_summary.frequency_analysis.most_frequent_second[0] if number_summary.frequency_analysis.most_frequent_second else 'N/A' }}</div>
                            <div class="stat-label">2등 최다번호</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>분석 정보</h3>
                    <p><strong>데이터 범위:</strong> {{ number_summary.analysis_summary.data_range if number_summary.analysis_summary else 'N/A' }}</p>
                    <p><strong>분석 일시:</strong> 
                        {% if number_summary.analysis_summary.analysis_date %}
                            {{ number_summary.analysis_summary.analysis_date[:19].replace('T', ' ') }}
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                    <p><strong>총 분석 회차:</strong> {{ "{:,}".format(number_summary.analysis_summary.total_rounds) if number_summary.analysis_summary else 'N/A' }}회</p>
                </div>
            </div>
            
            <div class="card">
                <h3>주요 인사이트</h3>
                {% if number_summary.companion_analysis.insights %}
                    <ul style="padding-left: 20px;">
                        {% for insight in number_summary.companion_analysis.insights %}
                            <li style="margin-bottom: 8px;">{{ insight }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>인사이트 데이터가 없습니다.</p>
                {% endif %}
            </div>
        {% else %}
            <div class="no-data">
                <h4>📋 분석 데이터가 없습니다</h4>
                <p>먼저 크롤링과 분석을 실행해주세요.</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="executeAction('crawl')">🕷️ 데이터 크롤링</button>
                    <button class="btn btn-success" onclick="executeAction('analyze')">📈 기본 분석</button>
                    <button class="btn btn-info" onclick="executeAction('number_analyze')">🔢 번호별 분석</button>
                </div>
            </div>
        {% endif %}
    </div>
    
    <!-- 출현 빈도 탭 -->
    <div id="frequency" class="tab-pane">
        <h3>🔢 번호별 출현 빈도</h3>
        
        {% if number_frequency %}
            <div class="grid">
                {% for pos in range(1, 7) %}
                    <div class="card">
                        <h3>{{ pos }}자리 출현 빈도</h3>
                        {% set pos_key = "1등_" + pos|string + "자리" %}
                        {% if number_frequency.first_numbers[pos_key] %}
                            <table class="frequency-table">
                                <thead>
                                    <tr>
                                        <th>숫자</th>
                                        <th>출현 횟수</th>
                                        <th>비율(%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% set total = number_frequency.first_numbers[pos_key].values() | sum %}
                                    {% for digit, count in number_frequency.first_numbers[pos_key].items() | sort(attribute='1', reverse=true) %}
                                        {% set percentage = ((count / total) * 100) | round(1) if total > 0 else 0 %}
                                        <tr>
                                            <td><strong>{{ digit }}</strong></td>
                                            <td>{{ count }}</td>
                                            <td>{{ percentage }}%</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>데이터가 없습니다.</p>
                        {% endif %}
                    </div>
                {% endfor %}
                
                <div class="card">
                    <h3>2등 끝자리 출현 빈도</h3>
                    <table class="frequency-table">
                        <thead>
                            <tr>
                                <th>끝자리</th>
                                <th>출현 횟수</th>
                                <th>비율(%)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set total_second = number_frequency.second_numbers.values() | sum %}
                            {% for digit, count in number_frequency.second_numbers.items() | sort(attribute='1', reverse=true) %}
                                {% set percentage = ((count / total_second) * 100) | round(1) if total_second > 0 else 0 %}
                                <tr>
                                    <td><strong>{{ digit }}</strong></td>
                                    <td>{{ count }}</td>
                                    <td>{{ percentage }}%</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="no-data">
                <h4>🔢 번호별 빈도 데이터가 없습니다</h4>
                <p>번호별 분석을 실행해주세요.</p>
                <button class="btn btn-info" onclick="executeAction('number_analyze')">🔢 번호별 분석 실행</button>
            </div>
        {% endif %}
    </div>
    
    <!-- 동반 출현 탭 -->
    <div id="companion" class="tab-pane">
        <h3>🤝 번호별 동반 출현 분석</h3>
        
        {% if companion_numbers and companion_numbers.top_companions %}
            <div class="grid">
                {% for pos in range(1, 7) %}
                    <div class="card">
                        <h3>{{ pos }}자리 주요 동반 출현</h3>
                        <div class="companion-list">
                            {% set found_data = false %}
                            {% for pos_digit, companions in companion_numbers.top_companions.items() %}
                                {% if pos_digit.startswith("자리" + pos|string + "_") %}
                                    {% set found_data = true %}
                                    {% set digit = pos_digit.split("_")[1] %}
                                    <div style="margin-bottom: 15px;">
                                        <strong style="color: #007bff;">{{ digit }}번과 함께 나온 숫자들:</strong>
                                        {% for comp_data in companions[:5] %}
                                            <div class="companion-item">
                                                <span>{{ comp_data[0] }}</span>
                                                <span><strong>{{ comp_data[1] }}회</strong></span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                            {% if not found_data %}
                                <p>해당 자리의 동반 출현 데이터가 없습니다.</p>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-data">
                <h4>🤝 동반 출현 데이터가 없습니다</h4>
                <p>번호별 분석을 실행해주세요.</p>
                <button class="btn btn-info" onclick="executeAction('number_analyze')">🔢 번호별 분석 실행</button>
            </div>
        {% endif %}
    </div>
    
    <!-- 트렌드 탭 -->
    <div id="trends" class="tab-pane">
        <h3>📈 최근 트렌드 분석</h3>
        
        {% if number_trends and number_trends.trend_scores %}
            <p><strong>분석 기간:</strong> {{ number_trends.analysis_period if number_trends.analysis_period else 'N/A' }}</p>
            
            <div class="grid">
                {% for pos in range(1, 7) %}
                    <div class="card">
                        <h3>{{ pos }}자리 트렌드 점수</h3>
                        {% set pos_key = "자리" + pos|string %}
                        {% if number_trends.trend_scores[pos_key] %}
                            <table class="frequency-table">
                                <thead>
                                    <tr>
                                        <th>숫자</th>
                                        <th>트렌드 점수</th>
                                        <th>최근 출현</th>
                                        <th>출현 횟수</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for digit, data in number_trends.trend_scores[pos_key].items() | sort(attribute='1.recent_score', reverse=true) %}
                                        {% set score = data.recent_score %}
                                        {% set score_class = "trend-hot" if score > 0.5 else ("trend-warm" if score > 0.3 else ("trend-cool" if score > 0.1 else "trend-cold")) %}
                                        <tr>
                                            <td><strong>{{ digit }}</strong></td>
                                            <td><span class="trend-score {{ score_class }}">{{ "%.2f"|format(score) }}</span></td>
                                            <td>{{ data.last_appearance }}회</td>
                                            <td>{{ data.frequency }}회</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p>해당 자리의 트렌드 데이터가 없습니다.</p>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-data">
                <h4>📈 트렌드 데이터가 없습니다</h4>
                <p>번호별 분석을 실행해주세요.</p>
                <button class="btn btn-info" onclick="executeAction('number_analyze')">🔢 번호별 분석 실행</button>
            </div>
        {% endif %}
    </div>
    
    <!-- 차트 탭 -->
    <div id="charts" class="tab-pane">
        <h3>📈 분석 차트</h3>
        
        <div class="chart-grid" id="charts-container">
            <!-- 차트들은 JavaScript로 동적 로드 -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 탭 기능
function showTab(tabName) {
    // 모든 탭과 탭 내용 숨기기
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
    
    // 선택된 탭과 내용 보이기
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    
    // 차트 탭이 선택되면 차트 로드
    if (tabName === 'charts') {
        loadCharts();
    }
}

// 차트 로드 함수
function loadCharts() {
    const container = document.getElementById('charts-container');
    if (!container) return;
    
    // 이미 로드되었으면 리턴
    if (container.children.length > 0) return;
    
    fetch('/api/charts')
    .then(response => response.json())
    .then(charts => {
        if (charts.length === 0) {
            container.innerHTML = `
                <div class="no-data">
                    <h4>📈 차트 데이터가 없습니다</h4>
                    <p>분석을 실행하여 차트를 생성해주세요.</p>
                    <button class="btn btn-success" onclick="executeAction('analyze')">📈 기본 분석</button>
                    <button class="btn btn-info" onclick="executeAction('number_analyze')">🔢 번호별 분석</button>
                </div>
            `;
            return;
        }
        
        let chartsHtml = '';
        charts.forEach(chart => {
            chartsHtml += `
                <div class="chart-container">
                    <h4>${chart.title}</h4>
                    <img src="/charts/${chart.filename}?v=${Date.now()}" 
                         alt="${chart.title}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; padding: 20px; background: #f8f9fa; border-radius: 6px; color: #6c757d;">
                        차트를 로드할 수 없습니다.
                    </div>
                    ${chart.modified ? `<small style="color: #6c757d;">생성: ${chart.modified}</small>` : ''}
                </div>
            `;
        });
        
        container.innerHTML = chartsHtml;
    })
    .catch(error => {
        container.innerHTML = `
            <div class="no-data">
                <h4>❌ 차트 로드 실패</h4>
                <p>차트를 불러오는 중 오류가 발생했습니다: ${error.message}</p>
            </div>
        `;
    });
}

// 페이지 로드 시 초기화
document.addEventListener('DOMContentLoaded', function() {
    // 현재 활성 탭이 차트면 차트 로드
    if (document.getElementById('charts').classList.contains('active')) {
        loadCharts();
    }
});
</script>
{% endblock %}