{% extends "base.html" %}

{% block title %}ì—°ê¸ˆë³µê¶Œ íŒ¨í„´ ë¶„ì„ - ë¶„ì„ ì‹¤í–‰{% endblock %}

{% block header_title %}ğŸ”¬ ë¶„ì„ ì‹¤í–‰ ì„¼í„°{% endblock %}
{% block header_subtitle %}ë‹¨ê³„ë³„ ë¶„ì„ ì‹¤í–‰ ë° ì§„í–‰ ìƒí™© ëª¨ë‹ˆí„°ë§{% endblock %}

{% block head %}
<style>
    .analysis-section {
        margin-bottom: 30px;
    }
    
    .analysis-step {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #6c757d;
        transition: all 0.3s ease;
    }
    
    .analysis-step.completed {
        border-left-color: #28a745;
    }
    
    .analysis-step.running {
        border-left-color: #007bff;
        animation: pulse 2s infinite;
    }
    
    .analysis-step.error {
        border-left-color: #dc3545;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        50% { box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        100% { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    }
    
    .step-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .step-title {
        font-size: 1.2em;
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .step-status {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-pending {
        background-color: #e9ecef;
        color: #6c757d;
    }
    
    .status-running {
        background-color: #cce7ff;
        color: #0066cc;
    }
    
    .status-completed {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-error {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .step-description {
        color: #6c757d;
        margin-bottom: 15px;
        line-height: 1.5;
    }
    
    .step-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    
    .progress-section {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .progress-container {
        margin: 15px 0;
    }
    
    .progress-label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: #6c757d;
    }
    
    .log-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .log-container {
        max-height: 300px;
        overflow-y: auto;
        background: #212529;
        color: #ffffff;
        padding: 15px;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 0.85em;
        line-height: 1.4;
    }
    
    .log-entry {
        margin-bottom: 5px;
        word-wrap: break-word;
    }
    
    .log-timestamp {
        color: #6c757d;
        margin-right: 8px;
    }
    
    .log-level-info {
        color: #17a2b8;
    }
    
    .log-level-warning {
        color: #ffc107;
    }
    
    .log-level-error {
        color: #dc3545;
    }
    
    .log-level-success {
        color: #28a745;
    }
    
    .results-preview {
        margin-top: 20px;
        padding: 15px;
        background: #e3f2fd;
        border-radius: 8px;
        border-left: 4px solid #2196f3;
    }
    
    .results-preview h5 {
        color: #1976d2;
        margin-bottom: 10px;
    }
    
    .file-list {
        list-style: none;
        padding: 0;
    }
    
    .file-list li {
        padding: 5px 0;
        color: #333;
    }
    
    .file-list li::before {
        content: "ğŸ“„ ";
        margin-right: 5px;
    }
    
    .quick-actions {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .quick-actions h3 {
        color: white;
        margin-bottom: 15px;
    }
    
    .quick-actions .btn {
        margin: 5px;
    }
</style>
{% endblock %}

{% block content %}
<!-- ë¹ ë¥¸ ì‹¤í–‰ íŒ¨ë„ -->
<div class="quick-actions">
    <h3>ğŸš€ ë¹ ë¥¸ ì‹¤í–‰</h3>
    <p>ì›í•˜ëŠ” ë¶„ì„ì„ ì„ íƒí•˜ì—¬ ì‹¤í–‰í•˜ì„¸ìš”. ê° ë‹¨ê³„ëŠ” ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</p>
    <div>
        <button class="btn btn-primary" onclick="executeAction('crawl')">
            ğŸ•·ï¸ 1ë‹¨ê³„: ë°ì´í„° í¬ë¡¤ë§
        </button>
        <button class="btn btn-success" onclick="executeAction('analyze')">
            ğŸ“ˆ 2ë‹¨ê³„: ê¸°ë³¸ ë¶„ì„
        </button>
        <button class="btn btn-info" onclick="executeAction('number_analyze')">
            ğŸ”¢ 3ë‹¨ê³„: ë²ˆí˜¸ë³„ ë¶„ì„
        </button>
        <button class="btn btn-secondary" onclick="executeAction('pattern_analyze')">
            ğŸ” 4ë‹¨ê³„: íŒ¨í„´ ë¶„ì„
        </button>
    </div>
</div>

<!-- ì§„í–‰ ìƒí™© -->
<div class="progress-section" id="progress-section" style="display: none;">
    <h3>ğŸ“Š ì§„í–‰ ìƒí™©</h3>
    <div class="progress-container">
        <div class="progress-label">
            <span id="progress-message">ëŒ€ê¸° ì¤‘...</span>
            <span id="progress-percentage">0%</span>
        </div>
        <div class="progress">
            <div class="progress-bar" id="progress-bar" style="width: 0%;">0%</div>
        </div>
    </div>
    <div id="current-task-info">
        <small class="text-muted">ì‘ì—… ID: <span id="current-task-id">-</span></small>
    </div>
</div>

<!-- ë¶„ì„ ë‹¨ê³„ -->
<div class="analysis-section">
    <h3>ğŸ“‹ ë¶„ì„ ë‹¨ê³„ë³„ í˜„í™©</h3>
    
    <!-- 1ë‹¨ê³„: ë°ì´í„° í¬ë¡¤ë§ -->
    <div class="analysis-step" id="step-crawl">
        <div class="step-header">
            <div class="step-title">
                <span>ğŸ•·ï¸</span>
                <span>1ë‹¨ê³„: ë°ì´í„° í¬ë¡¤ë§</span>
            </div>
            <div class="step-status status-pending" id="status-crawl">ëŒ€ê¸°</div>
        </div>
        <div class="step-description">
            ë™í–‰ë³µê¶Œ ì‚¬ì´íŠ¸ì—ì„œ ì—°ê¸ˆë³µê¶Œ ë‹¹ì²¨ë²ˆí˜¸ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤. 
            ëª¨ë“  íšŒì°¨ì˜ ë°ì´í„°ë¥¼ CSVì™€ JSON í˜•ì‹ìœ¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
        </div>
        <div class="step-actions">
            <button class="btn btn-primary" onclick="executeAction('crawl')">
                ğŸ•·ï¸ í¬ë¡¤ë§ ì‹¤í–‰
            </button>
            <small class="text-muted">ì˜ˆìƒ ì†Œìš”ì‹œê°„: 2-5ë¶„</small>
        </div>
        <div class="results-preview" id="results-crawl" style="display: none;">
            <h5>ğŸ“„ ìƒì„±ëœ íŒŒì¼</h5>
            <ul class="file-list">
                <li>lottery_data/pension_lottery_all.csv</li>
                <li>lottery_data/pension_lottery_all.json</li>
                <li>logs/crawling_log_*.txt</li>
            </ul>
        </div>
    </div>
    
    <!-- 2ë‹¨ê³„: ê¸°ë³¸ ë¶„ì„ -->
    <div class="analysis-step" id="step-analyze">
        <div class="step-header">
            <div class="step-title">
                <span>ğŸ“ˆ</span>
                <span>2ë‹¨ê³„: ê¸°ë³¸ ë¶„ì„</span>
            </div>
            <div class="step-status status-pending" id="status-analyze">ëŒ€ê¸°</div>
        </div>
        <div class="step-description">
            ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¡°ë³„ ì¶œí˜„ ë¹ˆë„, ìµœê·¼ íŠ¸ë Œë“œ, 2ë“± ëìë¦¬ íŒ¨í„´ì„ ë¶„ì„í•©ë‹ˆë‹¤.
        </div>
        <div class="step-actions">
            <button class="btn btn-success" onclick="executeAction('analyze')">
                ğŸ“ˆ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
            </button>
            <small class="text-muted">ì˜ˆìƒ ì†Œìš”ì‹œê°„: 1-2ë¶„</small>
        </div>
        <div class="results-preview" id="results-analyze" style="display: none;">
            <h5>ğŸ“„ ìƒì„±ëœ íŒŒì¼</h5>
            <ul class="file-list">
                <li>analysis_results/statistics_report.json</li>
                <li>charts/jo_frequency.png</li>
                <li>charts/recent_jo_frequency.png</li>
                <li>charts/last_digit_frequency.png</li>
            </ul>
        </div>
    </div>
    
    <!-- 3ë‹¨ê³„: ë²ˆí˜¸ë³„ ë¶„ì„ -->
    <div class="analysis-step" id="step-number">
        <div class="step-header">
            <div class="step-title">
                <span>ğŸ”¢</span>
                <span>3ë‹¨ê³„: ë²ˆí˜¸ë³„ ë¶„ì„</span>
            </div>
            <div class="step-status status-pending" id="status-number">ëŒ€ê¸°</div>
        </div>
        <div class="step-description">
            ê° ìë¦¬ë³„ ìˆ«ì ì¶œí˜„ ë¹ˆë„, ë™ë°˜ ì¶œí˜„ íŒ¨í„´, íŠ¸ë Œë“œ ì ìˆ˜ë¥¼ ìƒì„¸íˆ ë¶„ì„í•©ë‹ˆë‹¤.
        </div>
        <div class="step-actions">
            <button class="btn btn-info" onclick="executeAction('number_analyze')">
                ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„ ì‹¤í–‰
            </button>
            <small class="text-muted">ì˜ˆìƒ ì†Œìš”ì‹œê°„: 2-3ë¶„</small>
        </div>
        <div class="results-preview" id="results-number" style="display: none;">
            <h5>ğŸ“„ ìƒì„±ëœ íŒŒì¼</h5>
            <ul class="file-list">
                <li>analysis_results/number_frequency.json</li>
                <li>analysis_results/companion_numbers.json</li>
                <li>analysis_results/number_trends.json</li>
                <li>charts/number_frequency_by_position.png</li>
                <li>charts/companion_heatmap_pos*.png</li>
                <li>charts/number_trends.png</li>
            </ul>
        </div>
    </div>
    
    <!-- 4ë‹¨ê³„: íŒ¨í„´ ë¶„ì„ -->
    <div class="analysis-step" id="step-pattern">
        <div class="step-header">
            <div class="step-title">
                <span>ğŸ”</span>
                <span>4ë‹¨ê³„: íŒ¨í„´ ë¶„ì„</span>
            </div>
            <div class="step-status status-pending" id="status-pattern">ëŒ€ê¸°</div>
        </div>
        <div class="step-description">
            í™€ì§ ë¶„í¬, ì—°ì† íŒ¨í„´, ìˆ«ì ê°„ê²© ë“± ê³ ê¸‰ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ìˆ¨ê²¨ì§„ ê²½í–¥ì„ ì°¾ìŠµë‹ˆë‹¤.
        </div>
        <div class="step-actions">
            <button class="btn btn-secondary" onclick="executeAction('pattern_analyze')">
                ğŸ” íŒ¨í„´ ë¶„ì„ ì‹¤í–‰
            </button>
            <small class="text-muted">ì˜ˆìƒ ì†Œìš”ì‹œê°„: 3-4ë¶„</small>
        </div>
        <div class="results-preview" id="results-pattern" style="display: none;">
            <h5>ğŸ“„ ìƒì„±ëœ íŒŒì¼</h5>
            <ul class="file-list">
                <li>analysis_results/pattern_analysis_summary.json</li>
                <li>analysis_results/odd_even_patterns.json</li>
                <li>analysis_results/consecutive_patterns.json</li>
                <li>charts/pattern_analysis.png</li>
                <li>charts/gap_analysis.png</li>
            </ul>
        </div>
    </div>
</div>

<!-- ì‹¤ì‹œê°„ ë¡œê·¸ -->
<div class="log-section">
    <h3>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h3>
    <div class="log-container" id="log-container">
        <div class="log-entry">
            <span class="log-timestamp">[ì‹œìŠ¤í…œ]</span>
            <span class="log-level-info">ë¶„ì„ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. ì›í•˜ëŠ” ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”.</span>
        </div>
    </div>
</div>

<!-- ê²°ê³¼ ìš”ì•½ -->
<div class="card" id="results-summary" style="display: none;">
    <h3>ğŸ“Š ë¶„ì„ ê²°ê³¼ ìš”ì•½</h3>
    <div id="summary-content">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>
    <div style="text-align: center; margin-top: 20px;">
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
            ğŸ“Š ìƒì„¸ ëŒ€ì‹œë³´ë“œ ë³´ê¸°
        </a>
        <a href="{{ url_for('patterns') }}" class="btn btn-info">
            ğŸ” íŒ¨í„´ ë¶„ì„ ë³´ê¸°
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ë¶„ì„ í˜ì´ì§€ ì „ìš© JavaScript

class AnalysisPage {
    constructor() {
        this.stepStatuses = {
            'crawl': 'pending',
            'analyze': 'pending', 
            'number': 'pending',
            'pattern': 'pending'
        };
        
        this.init();
    }
    
    init() {
        this.updateStepStatuses();
        this.startStatusPolling();
    }
    
    // ë‹¨ê³„ ìƒíƒœ ì—…ë°ì´íŠ¸
    async updateStepStatuses() {
        try {
            const response = await fetch('/api/status');
            const status = await response.json();
            
            // ìƒíƒœ ë§¤í•‘
            this.stepStatuses.crawl = status.crawl_data_exists ? 'completed' : 'pending';
            this.stepStatuses.analyze = status.basic_analysis_exists ? 'completed' : 'pending';
            this.stepStatuses.number = status.number_analysis_exists ? 'completed' : 'pending';
            this.stepStatuses.pattern = status.pattern_analysis_exists ? 'completed' : 'pending';
            
            // UI ì—…ë°ì´íŠ¸
            this.updateStepUI();
            
        } catch (error) {
            console.error('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // ë‹¨ê³„ UI ì—…ë°ì´íŠ¸
    updateStepUI() {
        Object.entries(this.stepStatuses).forEach(([step, status]) => {
            const stepElement = document.getElementById(`step-${step}`);
            const statusElement = document.getElementById(`status-${step}`);
            const resultsElement = document.getElementById(`results-${step}`);
            
            if (stepElement && statusElement) {
                // í´ë˜ìŠ¤ ì œê±°
                stepElement.classList.remove('completed', 'running', 'error');
                statusElement.classList.remove('status-pending', 'status-running', 'status-completed', 'status-error');
                
                // ìƒˆë¡œìš´ ìƒíƒœ ì ìš©
                if (status === 'completed') {
                    stepElement.classList.add('completed');
                    statusElement.classList.add('status-completed');
                    statusElement.textContent = 'ì™„ë£Œ';
                    if (resultsElement) resultsElement.style.display = 'block';
                } else if (status === 'running') {
                    stepElement.classList.add('running');
                    statusElement.classList.add('status-running');
                    statusElement.textContent = 'ì‹¤í–‰ ì¤‘';
                } else if (status === 'error') {
                    stepElement.classList.add('error');
                    statusElement.classList.add('status-error');
                    statusElement.textContent = 'ì˜¤ë¥˜';
                } else {
                    statusElement.classList.add('status-pending');
                    statusElement.textContent = 'ëŒ€ê¸°';
                    if (resultsElement) resultsElement.style.display = 'none';
                }
            }
        });
    }
    
    // ë¡œê·¸ ì¶”ê°€
    addLog(message, level = 'info') {
        const logContainer = document.getElementById('log-container');
        if (!logContainer) return;
        
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-timestamp">[${timestamp}]</span>
            <span class="log-level-${level}">${message}</span>
        `;
        
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
        
        // ë¡œê·¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒ ì œê±°
        const logs = logContainer.querySelectorAll('.log-entry');
        if (logs.length > 100) {
            logs[0].remove();
        }
    }
    
    // ì§„í–‰ë¥  í‘œì‹œ
    showProgress(show, message = '', percentage = 0) {
        const progressSection = document.getElementById('progress-section');
        const progressMessage = document.getElementById('progress-message');
        const progressBar = document.getElementById('progress-bar');
        const progressPercentage = document.getElementById('progress-percentage');
        
        if (progressSection) {
            progressSection.style.display = show ? 'block' : 'none';
        }
        
        if (show && progressMessage) {
            progressMessage.textContent = message;
        }
        
        if (show && progressBar) {
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${Math.round(percentage)}%`;
        }
        
        if (show && progressPercentage) {
            progressPercentage.textContent = `${Math.round(percentage)}%`;
        }
    }
    
    // ìƒíƒœ í´ë§ ì‹œì‘
    startStatusPolling() {
        setInterval(() => {
            this.updateStepStatuses();
        }, 5000); // 5ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
    }
    
    // ì‘ì—… ì‹œì‘ ì²˜ë¦¬
    onTaskStart(action) {
        const stepMap = {
            'crawl': 'crawl',
            'analyze': 'analyze', 
            'number_analyze': 'number',
            'pattern_analyze': 'pattern'
        };
        
        const step = stepMap[action];
        if (step) {
            this.stepStatuses[step] = 'running';
            this.updateStepUI();
            this.showProgress(true, `${this.getActionName(action)} ì‹¤í–‰ ì¤‘...`, 0);
            this.addLog(`${this.getActionName(action)} ì‘ì—…ì„ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.`, 'info');
        }
    }
    
    // ì‘ì—… ì™„ë£Œ ì²˜ë¦¬
    onTaskComplete(action) {
        const stepMap = {
            'crawl': 'crawl',
            'analyze': 'analyze',
            'number_analyze': 'number', 
            'pattern_analyze': 'pattern'
        };
        
        const step = stepMap[action];
        if (step) {
            this.stepStatuses[step] = 'completed';
            this.updateStepUI();
            this.showProgress(false);
            this.addLog(`${this.getActionName(action)} ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        }
    }
    
    // ì‘ì—… ì‹¤íŒ¨ ì²˜ë¦¬
    onTaskError(action, error) {
        const stepMap = {
            'crawl': 'crawl',
            'analyze': 'analyze',
            'number_analyze': 'number',
            'pattern_analyze': 'pattern'
        };
        
        const step = stepMap[action];
        if (step) {
            this.stepStatuses[step] = 'error';
            this.updateStepUI();
            this.showProgress(false);
            this.addLog(`${this.getActionName(action)} ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error}`, 'error');
        }
    }
    
    // ì‘ì—…ëª… ë³€í™˜
    getActionName(action) {
        const names = {
            'crawl': 'ë°ì´í„° í¬ë¡¤ë§',
            'analyze': 'ê¸°ë³¸ ë¶„ì„',
            'number_analyze': 'ë²ˆí˜¸ë³„ ë¶„ì„',
            'pattern_analyze': 'íŒ¨í„´ ë¶„ì„'
        };
        return names[action] || action;
    }
}

// ë¶„ì„ í˜ì´ì§€ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
const analysisPage = new AnalysisPage();

// ê¸°ì¡´ í•¨ìˆ˜ë“¤ í™•ì¥
const originalExecuteAction = window.executeAction;
window.executeAction = function(action) {
    analysisPage.onTaskStart(action);
    if (originalExecuteAction) {
        originalExecuteAction(action);
    }
};
</script>
{% endblock %}