{% extends "base.html" %}

{% block title %}ì—°ê¸ˆë³µê¶Œ íŒ¨í„´ ë¶„ì„ - ë©”ì¸{% endblock %}

{% block content %}
<div class="grid">
    <!-- ì‹œìŠ¤í…œ ìƒíƒœ ì¹´ë“œ -->
    <div class="card">
        <h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3>
        <div id="system-status">
            {% if status %}
                <div class="status-item">
                    <strong>í¬ë¡¤ë§ ë°ì´í„°:</strong> 
                    {% if status.crawl_data_exists %}
                        <span style="color: #28a745;">âœ… ìˆìŒ</span>
                        {% if status.last_crawl %}
                            <small>(ìµœì¢…: {{ status.last_crawl }})</small>
                        {% endif %}
                    {% else %}
                        <span style="color: #dc3545;">âŒ ì—†ìŒ</span>
                    {% endif %}
                </div>
                
                <div class="status-item" style="margin-top: 10px;">
                    <strong>ê¸°ë³¸ ë¶„ì„:</strong>
                    {% if status.basic_analysis_exists %}
                        <span style="color: #28a745;">âœ… ì™„ë£Œ</span>
                        {% if status.last_analysis %}
                            <small>(ìµœì¢…: {{ status.last_analysis }})</small>
                        {% endif %}
                    {% else %}
                        <span style="color: #dc3545;">âŒ ë¯¸ì™„ë£Œ</span>
                    {% endif %}
                </div>
                
                <div class="status-item" style="margin-top: 10px;">
                    <strong>ë²ˆí˜¸ë³„ ë¶„ì„:</strong>
                    {% if status.number_analysis_exists %}
                        <span style="color: #28a745;">âœ… ì™„ë£Œ</span>
                        {% if status.last_number_analysis %}
                            <small>(ìµœì¢…: {{ status.last_number_analysis }})</small>
                        {% endif %}
                    {% else %}
                        <span style="color: #dc3545;">âŒ ë¯¸ì™„ë£Œ</span>
                    {% endif %}
                </div>
                
                {% if status.running_tasks > 0 %}
                    <div class="status-item" style="margin-top: 10px; color: #007bff;">
                        <strong>ğŸ”„ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…:</strong> {{ status.running_tasks }}ê°œ
                    </div>
                {% endif %}
            {% else %}
                <p>ìƒíƒœ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            {% endif %}
        </div>
    </div>
    
    <!-- ë¹ ë¥¸ ì‹¤í–‰ íŒ¨ë„ -->
    <div class="card">
        <h3>ğŸš€ ë¹ ë¥¸ ì‹¤í–‰</h3>

        <!-- ì—°ê¸ˆë³µê¶Œ íƒ€ì… ì„ íƒ -->
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
            <h4 style="margin-bottom: 10px;">ğŸ“‹ ì—°ê¸ˆë³µê¶Œ íƒ€ì… ì„ íƒ</h4>
            <div style="display: flex; gap: 15px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="lottery_type" value="720" checked style="margin-right: 8px;">
                    <span>ğŸ† ì—°ê¸ˆë³µê¶Œ720+ (ì›” 700ë§Œì› Ã— 20ë…„)</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="radio" name="lottery_type" value="520" style="margin-right: 8px;">
                    <span>ğŸ’° ì—°ê¸ˆë³µê¶Œ520 (ì›” 500ë§Œì› Ã— 20ë…„)</span>
                </label>
            </div>
        </div>

        <p>ê° ë‹¨ê³„ë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ì„¸ìš”:</p>

        <div style="margin: 20px 0;">
            <div style="margin-bottom: 15px;">
                <strong>1ë‹¨ê³„:</strong> ë°ì´í„° ìˆ˜ì§‘
                <div style="margin-top: 5px;">
                    <button class="btn btn-primary" onclick="executeActionWithType('crawl')">
                        ğŸ•·ï¸ ë°ì´í„° í¬ë¡¤ë§
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>2ë‹¨ê³„:</strong> ê¸°ë³¸ ë¶„ì„
                <div style="margin-top: 5px;">
                    <button class="btn btn-success" onclick="executeActionWithType('analyze')">
                        ğŸ“ˆ ê¸°ë³¸ ë¶„ì„ ì‹¤í–‰
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>3ë‹¨ê³„:</strong> ê³ ê¸‰ ë¶„ì„
                <div style="margin-top: 5px;">
                    <button class="btn btn-info" onclick="executeActionWithType('number_analyze')">
                        ğŸ”¢ ë²ˆí˜¸ë³„ ë¶„ì„ ì‹¤í–‰
                    </button>
                </div>
            </div>

            <div style="margin-bottom: 15px;">
                <strong>4ë‹¨ê³„:</strong> íŒ¨í„´ ë¶„ì„
                <div style="margin-top: 5px;">
                    <button class="btn btn-secondary" onclick="executeActionWithType('pattern_analyze')">
                        ğŸ” íŒ¨í„´ ë¶„ì„ ì‹¤í–‰
                    </button>
                </div>
            </div>
        </div>

        <div style="border-top: 1px solid #e9ecef; padding-top: 15px; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="refreshStatus()">
                ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨
            </button>
        </div>
    </div>
</div>

<!-- ê¸°ë³¸ í†µê³„ ì •ë³´ -->
{% if basic_stats and number_summary %}
<div class="grid">
    <div class="card">
        <h3>ğŸ“Š ê¸°ë³¸ í†µê³„</h3>
        <div class="stat-grid">
            <div class="stat-item">
                <div class="stat-value">{{ "{:,}".format(basic_stats.total_rounds) if basic_stats.total_rounds else 'N/A' }}</div>
                <div class="stat-label">ì´ íšŒì°¨</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-value">{{ basic_stats.most_frequent_jo.jo if basic_stats.most_frequent_jo else 'N/A' }}</div>
                <div class="stat-label">ìµœë‹¤ ì¶œí˜„ ì¡°</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-value">{{ number_summary.frequency_analysis.most_frequent_second[0] if number_summary.frequency_analysis.most_frequent_second else 'N/A' }}</div>
                <div class="stat-label">2ë“± ìµœë‹¤ ì¶œí˜„</div>
            </div>
            
            <div class="stat-item">
                <div class="stat-value">{{ number_summary.frequency_analysis.most_frequent_second[1] if number_summary.frequency_analysis.most_frequent_second else 'N/A' }}</div>
                <div class="stat-label">ì¶œí˜„ íšŸìˆ˜</div>
            </div>
        </div>
        
        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e9ecef;">
            <p><strong>ë°ì´í„° ë²”ìœ„:</strong> {{ number_summary.analysis_summary.data_range if number_summary.analysis_summary else 'N/A' }}</p>
            <p><strong>ìµœì¢… ë¶„ì„:</strong> 
                {% if number_summary.analysis_summary.analysis_date %}
                    {{ number_summary.analysis_summary.analysis_date[:19].replace('T', ' ') }}
                {% else %}
                    N/A
                {% endif %}
            </p>
        </div>
    </div>
    
    <div class="card">
        <h3>ğŸ’¡ ì£¼ìš” ì¸ì‚¬ì´íŠ¸</h3>
        {% if number_summary and number_summary.companion_analysis.insights %}
            <ul style="padding-left: 20px;">
                {% for insight in number_summary.companion_analysis.insights %}
                    <li style="margin-bottom: 8px;">{{ insight }}</li>
                {% endfor %}
            </ul>
        {% else %}
            <p>ì¸ì‚¬ì´íŠ¸ë¥¼ í‘œì‹œí•˜ë ¤ë©´ ë²ˆí˜¸ë³„ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</p>
        {% endif %}
    </div>
</div>

<!-- ìµœê·¼ ë¶„ì„ ì°¨íŠ¸ ë¯¸ë¦¬ë³´ê¸° -->
<div class="card">
    <h3>ğŸ“ˆ ìµœê·¼ ë¶„ì„ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°</h3>
    <div class="grid">
        {% set chart_files = [
            ('jo_frequency.png', 'ì¡°ë³„ ì¶œí˜„ ë¹ˆë„'),
            ('number_frequency_by_position.png', 'ìë¦¬ë³„ ìˆ«ì ì¶œí˜„ ë¹ˆë„'),
            ('number_trends.png', 'ë²ˆí˜¸ë³„ íŠ¸ë Œë“œ ì ìˆ˜')
        ] %}
        
        {% for filename, title in chart_files %}
            {% set chart_path = 'charts/' + filename %}
            <div style="text-align: center;">
                <h4 style="margin-bottom: 10px;">{{ title }}</h4>
                <img src="{{ url_for('serve_chart', filename=filename) }}"
                     onload="this.src += '?v=' + Date.now();"
                     alt="{{ title }}" 
                     style="max-width: 100%; height: auto; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <div style="display: none; padding: 20px; background: #f8f9fa; border-radius: 6px; color: #6c757d;">
                    ì°¨íŠ¸ë¥¼ ìƒì„±í•˜ë ¤ë©´ ë¶„ì„ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.
                </div>
            </div>
        {% endfor %}
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
        <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
            ğŸ“Š ì „ì²´ ëŒ€ì‹œë³´ë“œ ë³´ê¸°
        </a>
    </div>
</div>

{% else %}
<div class="card">
    <h3>ğŸ¯ ì‹œì‘í•˜ê¸°</h3>
    <div class="alert alert-info">
        <strong>í™˜ì˜í•©ë‹ˆë‹¤!</strong> ì—°ê¸ˆë³µê¶Œ íŒ¨í„´ ë¶„ì„ì„ ì‹œì‘í•˜ë ¤ë©´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¥´ì„¸ìš”:
        <ol style="margin-top: 15px; padding-left: 25px;">
            <li><strong>ë°ì´í„° í¬ë¡¤ë§:</strong> ë™í–‰ë³µê¶Œ ì‚¬ì´íŠ¸ì—ì„œ ì—°ê¸ˆë³µê¶Œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.</li>
            <li><strong>ê¸°ë³¸ ë¶„ì„:</strong> ì¡°ë³„ ì¶œí˜„ ë¹ˆë„, íŠ¸ë Œë“œ ë“± ê¸°ë³¸ì ì¸ íŒ¨í„´ì„ ë¶„ì„í•©ë‹ˆë‹¤.</li>
            <li><strong>ë²ˆí˜¸ë³„ ë¶„ì„:</strong> ê° ìë¦¬ë³„ ìˆ«ì ì¶œí˜„ ë¹ˆë„, ë™ë°˜ ì¶œí˜„ íŒ¨í„´ì„ ë¶„ì„í•©ë‹ˆë‹¤.</li>
        </ol>
    </div>
</div>
{% endif %}

<style>
.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.stat-value {
    font-size: 1.8em;
    font-weight: bold;
    color: #007bff;
}

.stat-label {
    font-size: 0.9em;
    color: #6c757d;
    margin-top: 5px;
}

.status-item {
    padding: 8px 0;
    border-bottom: 1px solid #f1f3f4;
}

.status-item:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// ìƒíƒœ ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜
function refreshStatus() {
    fetch('/api/status')
    .then(response => response.json())
    .then(data => {
        updateStatusDisplay(data);
        showAlert('ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    })
    .catch(error => {
        showAlert('ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    });
}

// ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateStatusDisplay(status) {
    const statusContainer = document.getElementById('system-status');
    if (!statusContainer) return;
    
    const formatTime = (timeStr) => timeStr ? `(ìµœì¢…: ${timeStr})` : '';
    
    statusContainer.innerHTML = `
        <div class="status-item">
            <strong>í¬ë¡¤ë§ ë°ì´í„°:</strong> 
            ${status.crawl_data_exists ? 
                `<span style="color: #28a745;">âœ… ìˆìŒ</span> <small>${formatTime(status.last_crawl)}</small>` :
                `<span style="color: #dc3545;">âŒ ì—†ìŒ</span>`
            }
        </div>
        <div class="status-item" style="margin-top: 10px;">
            <strong>ê¸°ë³¸ ë¶„ì„:</strong>
            ${status.basic_analysis_exists ? 
                `<span style="color: #28a745;">âœ… ì™„ë£Œ</span> <small>${formatTime(status.last_analysis)}</small>` :
                `<span style="color: #dc3545;">âŒ ë¯¸ì™„ë£Œ</span>`
            }
        </div>
        <div class="status-item" style="margin-top: 10px;">
            <strong>ë²ˆí˜¸ë³„ ë¶„ì„:</strong>
            ${status.number_analysis_exists ? 
                `<span style="color: #28a745;">âœ… ì™„ë£Œ</span> <small>${formatTime(status.last_number_analysis)}</small>` :
                `<span style="color: #dc3545;">âŒ ë¯¸ì™„ë£Œ</span>`
            }
        </div>
        ${status.running_tasks > 0 ? 
            `<div class="status-item" style="margin-top: 10px; color: #007bff;">
                <strong>ğŸ”„ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—…:</strong> ${status.running_tasks}ê°œ
            </div>` : ''
        }
    `;
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ìƒíƒœ í™•ì¸
document.addEventListener('DOMContentLoaded', function() {
    // 5ë¶„ë§ˆë‹¤ ìë™ìœ¼ë¡œ ìƒíƒœ í™•ì¸
    setInterval(refreshStatus, 300000);
});
</script>
{% endblock %}